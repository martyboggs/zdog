<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="zdog.dist.js"></script>
	<script src="musquito-1.1.2.min.js"></script>
	<script src="sounds.js"></script>
	<style>
	body {
		margin: 0;
		font-family: sans-serif;
	}
	#fps {
		color: black;
		position: fixed;
		top: 0;
		left: 0;
		padding: 5px;
	}
	#messages {
		color: black;
		position: fixed;
		text-align: center;
		font-size: 30px;
		top: 30px;
		margin: 0 120px;
		width: calc(100% - 240px);
	}
	#fullscreen {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0,0,0,0.4);
		z-index: 30;
	}
	</style>
</head>
<body>

<div id="fullscreen" style="display: none;">
	<button type="button" id="fullscreenyes">Go Fullscreen</button>
	<button type="button" id="fullscreenno">no thanks</button>
</div>
<div id="messages"></div>
<div id="fps">
	<div>Health: <span id="health"></span></div>
	<div>Lives: <span id="lives"></span></div>
	<div>Power: <span id="power"></span></div>
	<div><span id="items"></span></div>
</div>
<canvas class="zdog-canvas" id="zdog-canvas" width="800" height="600"></canvas>
<script src="objects/effect.js"></script>
<script src="objects/little-guy.js"></script>
<script src="objects/bad-guy.js"></script>
<script src="objects/steve.js"></script>
<script src="objects/player.js"></script>
<script src="objects/reindeer.js"></script>
<script src="objects/turtle.js"></script>
<script src="objects/key.js"></script>
<script src="objects/door.js"></script>
<script src="objects/plant.js"></script>
<script src="change-room.js"></script>
<script src="game.js"></script>
<script>
var nonPlayers = {
	reindeers: [],
	plants: [],
	turtles: [],
	littleGuys: [],
	badGuys: [],
	steves: [],
	effects: [],
	keys: [],
	doors: [],
};

var player = new Player();
changeRoom(1, 1);
document.getElementById('health').innerHTML = player.health;
document.getElementById('lives').innerHTML = player.lives;
document.getElementById('power').innerHTML = player.power;

var averageTimePerFrame = 0;
var time = 0;
function animate(timestamp) {
	for (var nonPlayer in nonPlayers) {
		for (var i = 0; i < nonPlayers[nonPlayer].length; i += 1) {
			nonPlayers[nonPlayer][i].update();
		}
	}
	player.update();

	// gravity
	let n;
	for (var nonPlayer in nonPlayers) {
		if (nonPlayer === 'plants') continue;
		for (var i = 0; i < nonPlayers[nonPlayer].length; i += 1) {
			n = nonPlayers[nonPlayer][i];
			if (n.action === 'walking') {
				if (n.model.translate.y < n.y0 - 50) {
					n.action = 'floating-away';
					n.ySpeed = 0;
					maps[level][room.z][room.x][nonPlayer] -= 1;
				} else if (n.model.translate.y < n.y0) {
					n.ySpeed += 0.5;
					n.model.translate.y += n.ySpeed;
				} else {
					n.model.translate.y = n.y0;
					n.model.rotate.x = 0;
					n.model.rotate.z = 0;
				}
			} else if (n.action === 'floating-away') {
				n.ySpeed -= 0.5;
				n.model.translate.y += n.ySpeed;
			} else if (n.action === 'floating') {
				n.model.rotate.x += 0.007;
				n.model.rotate.z += 0.005;
				if (keys[74] === 1) {
					n.action = 'walking';
					n.ySpeed = 0;
				}
			}
		}
	}

	illo.translate.x = -player.model.translate.x;

	illo.updateRenderGraph();
	frame = requestAnimationFrame( animate );
	// document.getElementById('fps').innerHTML = frame / timestamp * 1000;
}

function collision(a, b, distance) {
	if (a.translate.x > b.translate.x - distance && a.translate.x < b.translate.x + distance &&
	a.translate.z > b.translate.z - distance && a.translate.z < b.translate.z + distance) {
		return true;
	}
	return false;
}

animate();

var fullscreen;
document.getElementById('fullscreenyes').addEventListener('click', function (e) {
	document.body.requestFullscreen();
	document.getElementById('fullscreen').style.display = 'none';
	setTimeout(function () {
		resize();
	}, 10);
	fullscreen = 'on';

	// let gl = zdogCanvas.getContext('webgl');
	// gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
});
document.getElementById('fullscreenno').addEventListener('click', function (e) {
	fullscreen = 'off';
	document.getElementById('fullscreen').style.display = 'none';
});
document.addEventListener('fullscreenchange', function (e) {
	if (!document.fullscreenElement) {
		document.getElementById('fullscreen').style.display = 'block';
	}
})
</script>
</body>
</html>
